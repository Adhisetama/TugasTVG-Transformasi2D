<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2D Transformation</title>
    <style>
        body {
            width: 100vw;
            border: 0;
            padding: 0;
            margin: 0;
            font-family: Arial, Helvetica, sans-serif;
        }

        .main-h1 {
            width: 100vw;
            text-align: center;
        }

        .app-container {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        #canvas {
            width: 400px;
            height: 400px;
            border: 5px solid black;
            display: grid;
            grid-template-columns: repeat(100, 4px);
            grid-template-rows: repeat(100, 4px);
        }

        #canvas > div {
            width: 4px;
            height: 4px;
            border-right: 1px solid lightgray;
            border-bottom: 1px solid lightgray;
            box-sizing: border-box;
            grid-row-end: span 1;
            grid-column-end: span 1;
        }

        #trans-container {
            margin-top: 50px;
            width: 800px;
            height: 450px;
            display: grid;
            grid-template-columns: 300px 300px 200px;
            grid-template-rows: 150px 150px 150px;
            gap: 25px;
        }

        #trans-container > div.trans {
            box-sizing: border-box;
            padding: 20px;
            background-color: rgb(238, 238, 238);
            width: 100%;
            height: 100%;
        }

        #shear {
            grid-column: 1 / span 1;
            grid-row: 1 / span 1;
        }

        #translate {
            grid-column: 2 / span 1;
            grid-row: 1 / span 1;
        }

        #scale {
            grid-column: 1 / span 1;
            grid-row: 2 / span 1;
        }
        
        #rotate {
            grid-column: 2 / span 1;
            grid-row: 2 / span 1;
        }

        #reflect {
            grid-column: 3 / span 1;
            grid-row: 1 / span 2;
        }

        #reflect > button {
            margin-top: 10px;
        }

        .slider {
            width: 200px;
        }

        .buttons {
            grid-column: 1 / span 3;
            grid-row: 3 / span 1;
        }

        #display-color {
            grid-column: 1 / span 1;
            grid-row: 1 / span 1;
            width: 150px;
            height: 150px;
            background-color: black;
            align-self: center;
            justify-self: self-end;
            border: 5px solid black;
        }

        #input-color {
            align-self: center;
            grid-column: 2 / span 2;
            grid-row: 1 / span 1;
        }

        #display-tutorial {
            justify-self: center;
            grid-column: 1 / span 2;
            grid-row: 2 / span 1;
        }

        .none {
            display: none;
        }

    </style>
</head>
<body>
    <script>
        // function updateSlider(labelId, value) {
        //     const label = document.getElementById(labelId)
        //     label.innerHTML = value
        // }
    </script>
    <small>--- oleh: Muhammad Azka Adhisetama</small><br><small>--- 21/477807/TK/52628</small>
    <h1 class="main-h1">Transformasi 2D</h1>
    <div class="app-container">
        <div id="canvas"></div>
        <div id="trans-container">
            <div id="shear" class="trans t none">
                <p>Shear</p>
                <div><label for="shear-x">x: </label><input type="range" min="-100" max="100" value="0" class="slider" id="shear-x"><span id="shear-x-value">0</span></div>
                <div><label for="shear-y">y: </label><input type="range" min="-100" max="100" value="0" class="slider" id="shear-y"><span id="shear-y-value">0</span></div>
            </div>
            <div id="translate" class="trans t none">
                <p>Translasi</p>
                <div><label for="translate-x">x: </label><input type="range" min="-50" max="50" value="0" class="slider" id="translate-x"><span id="translate-x-value">0</span></div>
                <div><label for="translate-y">y: </label><input type="range" min="-50" max="50" value="0" class="slider" id="translate-y"><span id="translate-y-value">0</span></div>
            </div>
            <div id="scale" class="trans t none">
                <p>Scale</p>
                <div><label for="scale-x">x: </label><input type="range" min="0" max="100" value="33.3333" class="slider" id="scale-x"><span id="scale-x-value">1</span></div>
                <div><label for="scale-y">y: </label><input type="range" min="0" max="100" value="33.3333" class="slider" id="scale-y"><span id="scale-y-value">1</span></div>
            </div>
            <div id="rotate" class="trans t none">
                <p>Rotasi</p>
                <div><label for="rotate-t">θ: </label><input type="range" min="0" max="360" value="0" class="slider" id="rotate-t"><span id="rotate-t-value">0</span>°</div>
            </div>
            <div id="reflect" class="trans t none">
                <p>Refleksi</p>
                <button id="reflect-x"  >refleksi sumbu-x</button>
                <button id="reflect-y"  >refleksi sumbu-y</button>
                <button id="reflect-xy" >refleksi garis x=y</button>
                <button id="reflect-x-y">refleksi garis x=-y</button>
                <button id="reflect-0"  >refleksi titik (0,0)</button>
            </div>
            <div class="buttons t none">
                <button id="btn-reset">Reset</button>
                <button id="btn-new">New</button>
            </div>
            <div class="buttons d">
                <button id="btn-clear">Clear</button>
                <button id="btn-save">Save</button>
            </div>
            <!-- color picker -->
            <div id="display-color" class="d"></div>
            <div id="input-color" class="d">
                <b>color picker</b><br>
                <label for="rgb-r">r: </label><input type="range" min="0" max="255" value="0" class="slider" id="rgb-r"><span id="rgb-r-value">0</span><br>
                <label for="rgb-g">g: </label><input type="range" min="0" max="255" value="0" class="slider" id="rgb-g"><span id="rgb-g-value">0</span><br>
                <label for="rgb-b">b: </label><input type="range" min="0" max="255" value="0" class="slider" id="rgb-b"><span id="rgb-b-value">0</span>
            </div>
            <div id="display-tutorial" class="d">
                <ul>
                    <li>Anda dapat menggambar grafik di kanvas dengan menggunakan mouse anda.</li>
                    <li>Tekan mouse dan sapu melewati kanvas untuk menggambar.</li>
                    <li>Untuk mengganti warna pena, gunakan color picker.</li>
                    <li>Tombol "Clear" untuk menghapus / membersihkan isi kanvas.</li>
                    <li>Tombol "Save" untuk menyudahi sesi menggambar dan menyimpan gambar untuk ditransformasikan.</li>
                </ul>
            </div>
        </div>
    </div>
    <script>
        function toPointCoordinate (c) {
            return [c[0]-50, 50-c[1]]
        }
        function toIndexCoordinate (c) {
            return [c[0]+50, 50-c[1]]
        }

        const canvasContainer = document.getElementById('canvas')
        const canvas = [...Array(100)].map(e => Array(100))
        let points = []

        // inisialisasi appstate
        const AppState = {
            state: "drawing", // bisa 'drawing' ato 'transforming'
            canvasState: [...Array(100)].map(rows => [...Array(100)].map(element => { return {
                isActive: false,
                color: [255, 255, 255]
            }})),
            isMouseDown: false,
            penColor: [0,0,0],
            initialPoints: null,

            toggleState: function() {
                if (this.state == "drawing") {
                    this.state = "transforming"
                    dList = document.getElementsByClassName('d');
                    for (let e of dList) {
                        e.classList.add('none');
                    }
                    tList = document.getElementsByClassName('t');
                    for (let e of tList) {
                        e.classList.remove('none');
                    }
                    // hide color picker, show transformation, change buttons, lock canvas
                } else if (this.state == "transforming") {
                    this.state = "drawing"
                    // show color picker, hide transformation, change buttons, enable canvas
                    dList = document.getElementsByClassName('d');
                    for (let e of dList) {
                        e.classList.remove('none');
                    }
                    tList = document.getElementsByClassName('t');
                    for (let e of tList) {
                        e.classList.add('none');
                    }
                }
            },
            clearCanvas: function() {
                this.canvasState = [...Array(100)].map(rows => [...Array(100)].map(element => { return {
                isActive: false,
                color: [255, 255, 255]
            }}))
                canvas.forEach(row => row.forEach(e => e.style.backgroundColor = 'white'))
            },
            drawCanvas: function (dimension, colors) {
                [row, col] = dimension;
                [r, g, b] = colors;
                try {
                    canvas[row][col].style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                    this.canvasState[row][col].isActive = true;
                    this.canvasState[row][col].color = colors;
                } catch (e) {

                }
            },
            savePointsFromCanvas: function() {
                this.canvasState.forEach((row, rowIndex) => row.forEach((point, colIndex) => {
                    if (point.isActive) {
                        points.push({
                            color: point.color,
                            coordinate: toPointCoordinate([rowIndex, colIndex])
                        })
                    }
                }))
                this.initialPoints = points
            },
            drawPointsToCanvas: function() {
                this.clearCanvas();
                points.forEach(p => {
                    let c = toIndexCoordinate(p.coordinate);
                    c = [Math.round(c[0]), Math.round(c[1])];
                    if (c[0] < 100 && c[1] < 100) {
                        AppState.drawCanvas(c, p.color)
                    }
                })
            }
        }

        document.onmousedown = () => AppState.isMouseDown = true;
        document.onmouseup = () => AppState.isMouseDown = false;

        // gambar semua subdiv kanvas (inisialisasi)
        for (let col = 0; col < 100; col++)
            for (let row = 0; row < 100; row++)
                {
                    const pixelElement = document.createElement('div');
                    pixelElement.style.gridRowStart = row + 1;
                    pixelElement.style.gridColumnStart = col + 1;
                    if (col == 49)
                        pixelElement.style.borderRightColor = 'lightCoral'
                    if (row == 49)
                        pixelElement.style.borderBottomColor = 'lightCoral'
                    pixelElement.setAttribute('id', `${col}-${row}`)
                    pixelElement.addEventListener('mouseover', e => {
                        if (AppState.state == "drawing" && AppState.isMouseDown)
                        {
                            AppState.drawCanvas([row, col], AppState.penColor);
                            AppState.drawCanvas([row+1, col], AppState.penColor);
                            AppState.drawCanvas([row-1, col], AppState.penColor);
                            AppState.drawCanvas([row, col+1], AppState.penColor);
                            AppState.drawCanvas([row, col-1], AppState.penColor);
                        }
                    })
                    canvasContainer.appendChild(pixelElement)
                    canvas[row][col] = pixelElement;
                }
        
        buttons = {
            // d
            save: document.getElementById('btn-save'),
            clear: document.getElementById('btn-clear'),
            load: document.getElementById('btn-load'),
            // t
            reset: document.getElementById('btn-reset'),
            new: document.getElementById('btn-new'),
        }

        // ketika tombol save/new ditekan (state berubah)
        buttons.save.addEventListener('click', (e) => {
            AppState.toggleState();
            AppState.savePointsFromCanvas();
        })
        buttons.new.addEventListener('click', (e) => {
            AppState.toggleState();
            AppState.clearCanvas();
            points = [];
        })
        // ketika tombol reset ditekan, kembali ke initialpoint
        buttons.reset.addEventListener('click', (e) => {
            points = AppState.initialPoints;
            AppState.drawPointsToCanvas();
            T.reset();
        })
        // ketika clear, maka ya clear
        buttons.clear.addEventListener('click', (e) => {
            AppState.clearCanvas();
            points = [];
        })

        // mengenai color picker....
        const colorPicker = {
            display: document.getElementById('display-color'),
            input: {
                r: document.getElementById('rgb-r'),
                g: document.getElementById('rgb-g'),
                b: document.getElementById('rgb-b'),

                rLabel: document.getElementById('rgb-r-value'),
                gLabel: document.getElementById('rgb-g-value'),
                bLabel: document.getElementById('rgb-b-value'),

                getValue: function() {
                    return [
                        this.r.value,
                        this.g.value,
                        this.b.value
                    ]
                },

                updateLabel: function() {
                    [r, g, b] = this.getValue();
                    this.rLabel.innerHTML = r;
                    this.gLabel.innerHTML = g;
                    this.bLabel.innerHTML = b;
                }
            },
            updateDisplay: function() {
                [r, g, b] = this.input.getValue();
                this.display.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                AppState.penColor = [r, g, b];
            }
        }
        colorPicker.input.r.addEventListener('change', () => {colorPicker.input.updateLabel(); colorPicker.updateDisplay()})
        colorPicker.input.g.addEventListener('change', () => {colorPicker.input.updateLabel(); colorPicker.updateDisplay()})
        colorPicker.input.b.addEventListener('change', () => {colorPicker.input.updateLabel(); colorPicker.updateDisplay()})

        // mengenai transformasi....
        const Transform = {
            shear: {
                x: (c, sx) => [c[0], c[1] + sx*c[0]],
                y: (c, sy) => [c[0] + sy*c[1], c[1]]
            },
            scale: {
                x: (c, sx) => [c[0], c[1] / sx],
                y: (c, sy) => [c[0] / sy, c[1]]
            },
            translate: {
                x: (c, tx) => [c[0], c[1] - tx],
                y: (c, ty) => [c[0] - ty, c[1]]
            },
            rotate: (c, t) => [

                // Math.cos(t)*(c[1]-p[1]) + Math.sin(t)*(c[0]-p[0]) + p[1],
                // Math.cos(t)*(c[0]-p[0]) - Math.sin(t)*(c[1]-p[1]) + p[0],
                Math.cos(-t)*c[0] - Math.sin(-t)*c[1],
                Math.sin(-t)*c[0] + Math.cos(-t)*c[1]
            ],
            reflect: {
                x_axis: c => [-c[0], c[1]],
                y_axis: c => [c[0], -c[1]],
                xy_line: c => [c[1], c[0]],
                x_y_line: c => [-c[1], -c[0]],
                point_O: c => [-c[0], -c[1]]
            }
        }

        // semua input/tombol transformasi
        const T = {
            shear: { // bisa dari -100 sampai 100
                prev: [0,0],
                x: document.getElementById('shear-x'),
                y: document.getElementById('shear-y'),
                xLabel: document.getElementById('shear-x-value'),
                yLabel: document.getElementById('shear-y-value'),
            },
            translate: {
                prev: [0,0],
                x: document.getElementById('translate-x'),
                y: document.getElementById('translate-y'),
                xLabel: document.getElementById('translate-x-value'),
                yLabel: document.getElementById('translate-y-value'),
            },
            scale: {
                prev: {
                    x: 1,
                    y: 1
                },
                x: document.getElementById('scale-x'),
                y: document.getElementById('scale-y'),
                xLabel: document.getElementById('scale-x-value'),
                yLabel: document.getElementById('scale-y-value'),
                getDiff(axis) {
                    let temp = this.prev[axis];
                    this.prev[axis] = 0.5 + this[axis].value / 100 * 1.5;
                    return temp / this.prev[axis]; 
                }
            },
            rotate: {
                prevT: 0,
                t: document.getElementById('rotate-t'),
                tLabel: document.getElementById('rotate-t-value'),
                getDiffT: function() {
                    const temp_prev = this.prevT;
                    this.prevT = Number(this.t.value);
                    console.log(this.prevT - temp_prev, this.prevT, temp_prev)
                    return this.prevT - temp_prev;
                }
            },
            reflect: {
                x_axis: document.getElementById('reflect-x'),
                y_axis: document.getElementById('reflect-y'),
                xy_line: document.getElementById('reflect-xy'),
                x_y_line: document.getElementById('reflect-x-y'),
                point_O: document.getElementById('reflect-0'),
            },
            reset: function() {
                this.shear.x.value = 0;
                this.shear.y.value = 0;
                this.shear.prev = [0,0];
                this.shear.xLabel.innerHTML = 0;
                this.shear.yLabel.innerHTML = 0;
                this.translate.x.value = 0;
                this.translate.y.value = 0;
                this.translate.prev = [0,0];
                this.translate.xLabel.innerHTML = 0;
                this.translate.yLabel.innerHTML = 0;
                this.scale.x.value = 33.3333;
                this.scale.y.value = 33.3333;
                this.scale.prev = [1,1];
                this.scale.xLabel.innerHTML = 1;
                this.scale.yLabel.innerHTML = 1;
                this.rotate.t.value = 0;
                this.rotate.tLabel.innerHTML = 0;
                this.rotate.prevT = 0;
            },
            getDiff: function(propName, axis, normalFactor=1) {
                let temp = this[propName][axis].value - this[propName].prev[0];
                this[propName].prev[0] = this[propName][axis].value;
                return temp / normalFactor;
            }
        }
        // 1. shear
        T.shear.x.addEventListener('change', e => {
            const Sx = T.getDiff('shear', 'x', 50);
            points = points.map(p => {
                newCoordinate = Transform.shear.x(p.coordinate, Sx);
                return {
                    color: p.color,
                    coordinate: newCoordinate
                }
            });
            T.shear.xLabel.innerHTML = T.shear.x.value / 50;
            AppState.drawPointsToCanvas();
        })
        T.shear.y.addEventListener('change', e => {
            const Sy = T.getDiff('shear', 'y', 50);
            points = points.map(p => {
                newCoordinate = Transform.shear.y(p.coordinate, Sy);
                return {
                    color: p.color,
                    coordinate: newCoordinate
                }
            });
            T.shear.yLabel.innerHTML = T.shear.y.value / 50;
            AppState.drawPointsToCanvas();
        })
        // 2. translate
        T.translate.x.addEventListener('change', e => {
            const Sx = T.getDiff('translate', 'x');
            points = points.map(p => {
                newCoordinate = Transform.translate.x(p.coordinate, Sx);
                return {
                    color: p.color,
                    coordinate: newCoordinate
                }
            });
            T.translate.xLabel.innerHTML = T.translate.x.value;
            AppState.drawPointsToCanvas();
        })
        T.translate.y.addEventListener('change', e => {
            const Sy = T.getDiff('translate', 'y');
            points = points.map(p => {
                newCoordinate = Transform.translate.y(p.coordinate, Sy);
                return {
                    color: p.color,
                    coordinate: newCoordinate
                }
            });
            T.translate.yLabel.innerHTML = T.translate.y.value;
            AppState.drawPointsToCanvas();
        })
        // 3. scale
        T.scale.x.addEventListener('change', e => {
            console.log(T.scale.prev)
            const Sx = T.scale.getDiff('x');
            points = points.map(p => {
                newCoordinate = Transform.scale.x(p.coordinate, Sx);
                return {
                    color: p.color,
                    coordinate: newCoordinate
                }
            });
            T.scale.xLabel.innerHTML = 0.5 + T.scale.x.value / 100 * 1.5;
            AppState.drawPointsToCanvas();
        })
        T.scale.y.addEventListener('change', e => {
            console.log(T.scale.prev)
            const Sy = T.scale.getDiff('y');
            points = points.map(p => {
                newCoordinate = Transform.scale.y(p.coordinate, Sy);
                return {
                    color: p.color,
                    coordinate: newCoordinate
                }
            });
            T.scale.yLabel.innerHTML = 0.5 + T.scale.y.value / 100 * 1.5;
            AppState.drawPointsToCanvas();
        })
        T.reflect.x_axis.addEventListener('click', e => {
            points = points.map(p => {
                return {
                    color: p.color,
                    coordinate: Transform.reflect.x_axis(p.coordinate)
                }
            })
            AppState.drawPointsToCanvas();
        });
        T.reflect.y_axis.addEventListener('click', e => {
            points = points.map(p => {
                return {
                    color: p.color,
                    coordinate: Transform.reflect.y_axis(p.coordinate)
                }
            })
            AppState.drawPointsToCanvas();
        });
        T.reflect.xy_line.addEventListener('click', e => {
            points = points.map(p => {
                return {
                    color: p.color,
                    coordinate: Transform.reflect.xy_line(p.coordinate)
                }
            })
            AppState.drawPointsToCanvas();
        });
        T.reflect.x_y_line.addEventListener('click', e => {
            points = points.map(p => {
                return {
                    color: p.color,
                    coordinate: Transform.reflect.x_y_line(p.coordinate)
                }
            })
            AppState.drawPointsToCanvas();
        });
        T.reflect.point_O.addEventListener('click', e => {
            points = points.map(p => {
                return {
                    color: p.color,
                    coordinate: Transform.reflect.point_O(p.coordinate)
                }
            })
            AppState.drawPointsToCanvas();
        });
        T.rotate.t.addEventListener('change', e => {
            const radians = T.rotate.getDiffT() / 180 * Math.PI;
            points = points.map(p => {
                return {
                    color: p.color,
                    coordinate: Transform.rotate(p.coordinate, radians)
                }
            });
            T.rotate.tLabel.innerHTML = T.rotate.t.value;
            AppState.drawPointsToCanvas();
        })
    </script>
</body>
</html>